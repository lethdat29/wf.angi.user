name: Build and Push Docker Image for angi.user

on:
  repository_dispatch:
    types: [gitea-push]
  workflow_dispatch:
  schedule:
    - cron: "* * * * *"  # Runs daily at midnight

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Clone another repo
        run: |
          echo "Cloning repository... ${{ secrets.GITEA_TOKEN }}"

          git clone https://${{ secrets.GITEA_USERNAME }}:${{ secrets.GITEA_TOKEN }}@gitea.com/angi/angi.user.git
          cd angi.user
          ls -la
          COMMIT_SHA=$(git rev-parse --short HEAD)
          echo "Commit SHA: $COMMIT_SHA"
          echo "COMMIT_SHA=$COMMIT_SHA" >> $GITHUB_ENV
      - name: Build Docker image
        run: |
          cd angi.user
          docker login quay.io -u ${{ secrets.QUAY_USERNAME }} -p ${{ secrets.QUAY_TOKEN }}
          docker build -t quay.io/${{ secrets.QUAY_USERNAME }}/angi.user:${{ env.COMMIT_SHA }} .
      - name: Push Docker image
        if: success()
        run: |
          docker push quay.io/${{ secrets.QUAY_USERNAME }}/angi.user:${{ env.COMMIT_SHA }}
          echo "Docker image pushed successfully."
