name: Build and Push Docker Image for angi.user

on:
  repository_dispatch:
    types: [gitea-push]
  workflow_dispatch:
  schedule:
    - cron: "* * * * *"  # Runs daily at midnight

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      IMG_TAG: ${{ steps.set_img_tag.outputs.IMG_TAG }}
    steps:
      - name: Clone another repo
        run: |
          echo "Cloning repository..."

          git clone --depth=1 https://${{ secrets.GITEA_USERNAME }}:${{ secrets.GITEA_TOKEN }}@gitea.com/angi/angi.user.git
          cd angi.user
          ls -la
          COMMIT_SHA=$(git rev-parse --short HEAD)
          echo "Commit SHA: $COMMIT_SHA"
          echo "COMMIT_SHA=$COMMIT_SHA" >> $GITHUB_ENV
      - name: Build Docker image
        run: |
          cd angi.user
          docker login quay.io -u ${{ secrets.QUAY_USERNAME }} -p ${{ secrets.QUAY_TOKEN }}
          docker build -t quay.io/angi/angi.user:${{ env.COMMIT_SHA }}.${{ github.run_number }} .
      - name: Push Docker image
        if: success()
        run: |
          docker push quay.io/angi/angi.user:${{ env.COMMIT_SHA }}.${{ github.run_number }}
          echo "Docker image pushed successfully."
      - name: Set image tag for deployment
        id: set_img_tag
        run: echo "IMG_TAG=${{ env.COMMIT_SHA }}.${{ github.run_number }}" >> $GITHUB_OUTPUT
      - name: Notify Telegram on success
        if: success()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELE_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="✅ Build job ${{ github.job }} completed successfully! Tag: ${{ steps.set_img_tag.outputs.IMG_TAG }}"

      - name: Notify Telegram on failure
        if: failure()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELE_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="❌ Build job ${{ github.job }} failed!"
  deploy:
    runs-on: ubuntu-latest
    needs: build
    env:
      KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
      IMAGE_TAG: ${{ needs.build.outputs.IMG_TAG }}
    steps:
      - name: debug
        run: |
          echo "IMAGE_TAG: $IMAGE_TAG"
      # echo "KUBE_CONFIG_DATA: $KUBE_CONFIG_DATA"
      # - name: Set up kubeconfig
      #   run: |
      #     mkdir -p $HOME/.kube
      #     echo "$KUBE_CONFIG_DATA" | base64 --decode > $HOME/.kube/config
      #     cat $HOME/.kube/config

      # - name: Deploy to K3s
      #   run: |
      #     echo "Deploying Docker image to K3s..."
      #     kubectl set image deployment/angi-user angi-user=quay.io/angi/angi.user:${{ env.COMMIT_SHA }}.${{ github.run_number }} --kubeconfig ${{ secrets.K3S_KUBECONFIG }}